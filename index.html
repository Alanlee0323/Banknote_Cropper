<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banknote Autocrop - Smart Review</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        navy: { 950: '#0B0F19', 900: '#0f172a', 800: '#151B2D', 700: '#1e293b' },
                        brand: { blue: '#3b82f6', green: '#10b981', accent: '#6366f1' }
                    }
                }
            }
        }
    </script>
    
    <script type="py-config">{ "packages": ["micropip"] }</script>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.6.1/core.js"></script>

    <style>
        .loading-overlay { backdrop-filter: blur(8px); background-color: rgba(11, 15, 25, 0.9); }
        .bg-checkerboard {
            background-color: #e5e5f7;
            background-image:  linear-gradient(45deg, #f4f4f5 25%, transparent 25%), linear-gradient(-45deg, #f4f4f5 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f4f4f5 75%), linear-gradient(-45deg, transparent 75%, #f4f4f5 75%);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-navy-950 text-slate-200 min-h-screen flex flex-col font-sans antialiased">

    <!-- Loading Overlay -->
    <div id="env-loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center transition-opacity duration-500 loading-overlay">
        <div class="w-16 h-16 border-4 border-slate-700 border-t-brand-blue rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-white">Initializing Engine</h2>
        <p id="loader-status" class="text-slate-400 text-sm mt-2">Loading core components...</p>
    </div>

    <!-- Nav -->
    <nav class="border-b border-navy-700 bg-navy-950/80 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-bolt text-brand-blue text-xl"></i>
                <span class="font-bold text-lg">Smart Review</span>
            </div>
            <div id="progress-indicator" class="hidden flex items-center gap-4">
                <span class="text-sm text-slate-400">Processed: <span id="processed-count" class="text-white font-bold">0/0</span></span>
                <div class="w-32 h-2 bg-navy-800 rounded-full overflow-hidden">
                    <div id="nav-progress-bar" class="h-full bg-brand-green w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full flex flex-col h-full">

        <!-- 1. Upload -->
        <div id="step-upload" class="flex flex-col items-center justify-center py-20 border-2 border-dashed border-navy-700 rounded-2xl bg-navy-900/30 hover:border-brand-blue/50 transition-all cursor-pointer">
            <i class="fa-solid fa-folder-open text-5xl text-brand-blue mb-6"></i>
            <h3 class="text-2xl font-bold text-white mb-2">Drop Folder Here</h3>
            <p class="text-slate-400 mb-8">Strict mode active. Python deskewing logic enabled.</p>
            <div class="flex gap-4">
                <button onclick="document.getElementById('folder-input').click()" class="px-6 py-3 bg-brand-blue hover:bg-blue-600 text-white rounded-lg font-bold shadow-lg transition-transform active:scale-95">Select Folder</button>
                <input id="folder-input" type="file" class="hidden" webkitdirectory directory />
            </div>
        </div>

        <!-- 2. Processing -->
        <div id="step-processing" class="hidden flex flex-col items-center justify-center py-20">
            <div class="w-20 h-20 border-4 border-navy-800 border-t-brand-accent rounded-full animate-spin mb-8"></div>
            <h3 class="text-2xl font-bold text-white mb-2">Analyzing Images...</h3>
            <p id="analyze-status" class="text-slate-400">Calculating precise crops & rotation...</p>
        </div>

        <!-- 3. Review -->
        <div id="step-review" class="hidden flex-grow flex flex-col lg:flex-row gap-6 h-full">
            <!-- List -->
            <div class="lg:w-1/3 flex flex-col gap-4">
                <div class="bg-navy-800 p-4 rounded-xl border border-navy-700">
                    <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">Current Batch</h4>
                    <div class="text-2xl font-bold text-white mb-1"><span id="review-idx">1</span> <span class="text-lg text-slate-500">/ <span id="review-total">100</span></span></div>
                    <div class="h-1 bg-navy-950 rounded-full mt-2 overflow-hidden">
                        <div id="review-progress" class="h-full bg-brand-blue w-0 transition-all"></div>
                    </div>
                </div>
                <div class="flex-grow bg-navy-900 rounded-xl border border-navy-700 overflow-y-auto p-2 space-y-2" style="max-height: 60vh">
                    <div id="thumbnail-list"></div>
                </div>
            </div>

            <!-- Editor -->
            <div class="lg:w-2/3 flex flex-col">
                <div class="relative bg-checkerboard rounded-xl border border-navy-700 overflow-hidden flex-grow flex items-center justify-center shadow-2xl group" style="min-height: 500px;">
                    
                    <!-- Preview Image (From Python) -->
                    <img id="review-image" class="max-w-full max-h-full object-contain shadow-lg" />
                    
                    <!-- Edit Mode Container -->
                    <div id="edit-wrapper" class="absolute inset-0 bg-navy-950 hidden z-20">
                        <img id="edit-image" class="max-w-full h-full opacity-0" />
                        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-4 bg-navy-900/90 p-2 rounded-full backdrop-blur border border-navy-700 shadow-xl z-30">
                            <button onclick="saveEdit()" class="px-6 h-10 rounded-full bg-brand-green hover:bg-green-600 text-white font-bold">Done</button>
                            <button onclick="cancelEdit()" class="w-10 h-10 rounded-full bg-navy-800 hover:bg-red-900/50 text-red-400"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>

                    <!-- Overlay -->
                    <div id="action-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
                        <div class="flex gap-4 pointer-events-auto transform translate-y-4 group-hover:translate-y-0 transition-transform duration-200">
                            <button onclick="enterEditMode()" class="px-6 py-3 bg-white text-navy-900 rounded-lg font-bold hover:bg-slate-200 shadow-lg">
                                <i class="fa-solid fa-pen-to-square mr-2"></i> Adjust
                            </button>
                            <button onclick="approveCurrent()" class="px-8 py-3 bg-brand-blue text-white rounded-lg font-bold hover:bg-blue-600 shadow-lg">
                                <i class="fa-solid fa-check mr-2"></i> Approve (Space)
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-4 px-2">
                    <p id="filename-display" class="text-slate-400 font-mono text-sm truncate w-1/2">filename.jpg</p>
                    <div class="text-xs text-slate-500">Press Space to Next</div>
                </div>
            </div>
        </div>

        <!-- 4. Finalizing -->
        <div id="step-final" class="hidden text-center py-20">
            <h2 class="text-3xl font-bold text-white mb-4">Packing Dataset...</h2>
            <p class="text-slate-400 mb-8">Creating ZIP and syncing shadow data.</p>
            <button id="dl-btn" class="px-8 py-4 bg-brand-green text-white rounded-full font-bold shadow-xl text-lg hidden">Download ZIP</button>
        </div>

    </main>

    <script>
        let fileList = [];
        let metaCache = {};
        let previewCache = {}; // Stores Blobs
        let currentIndex = 0;
        let cropper = null;

        document.getElementById('folder-input').addEventListener('change', (e) => {
            fileList = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
            if(fileList.length === 0) return;
            document.getElementById('step-upload').classList.add('hidden');
            document.getElementById('step-processing').classList.remove('hidden');
            processBatchAnalysis();
        });

        async function processBatchAnalysis() {
            const total = fileList.length;
            const status = document.getElementById('analyze-status');
            const navProg = document.getElementById('nav-progress-bar');
            document.getElementById('progress-indicator').classList.remove('hidden');
            
            for (let i = 0; i < total; i++) {
                const file = fileList[i];
                status.innerText = `Analyzing ${i+1}/${total}: ${file.name}`;
                document.getElementById('processed-count').innerText = `${i+1}/${total}`;
                navProg.style.width = `${((i+1)/total)*100}%`;

                const buffer = await file.arrayBuffer();
                await new Promise(resolve => {
                    let handled = false;
                    
                    // 1. Success Callback
                    window.storeAnalysisResult = (filename, meta, previewBuffer) => {
                        if(handled) return;
                        handled = true;
                        metaCache[filename] = meta;
                        if (previewBuffer) {
                            previewCache[filename] = new Blob([previewBuffer], { type: 'image/png' });
                        }
                        resolve();
                    };

                    // 2. Timeout Safety Net (10 seconds)
                    setTimeout(() => {
                        if(!handled) {
                            console.warn(`Timeout analyzing: ${file.name} - Skipping`);
                            handled = true;
                            // Mock a "not found" result so flow continues
                            metaCache[file.name] = { found: false }; 
                            resolve();
                        }
                    }, 10000);
                    
                    window.dispatchEvent(new CustomEvent('py-analyze', {
                        detail: { buffer: new Uint8Array(buffer), filename: file.name }
                    }));
                });
            }
            startReview();
        }

        function startReview() {
            document.getElementById('step-processing').classList.add('hidden');
            document.getElementById('step-review').classList.remove('hidden');
            document.getElementById('review-total').innerText = fileList.length;
            renderThumbnailList();
            showCurrentImage();
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && document.getElementById('edit-wrapper').classList.contains('hidden')) {
                    e.preventDefault();
                    approveCurrent();
                }
            });
        }

        function renderThumbnailList() {
            const list = document.getElementById('thumbnail-list');
            list.innerHTML = '';
            fileList.forEach((f, idx) => {
                const div = document.createElement('div');
                div.className = `p-2 rounded cursor-pointer hover:bg-navy-800 text-xs text-slate-400 truncate ${idx === currentIndex ? 'bg-navy-800 text-white border-l-2 border-brand-blue' : ''}`;
                div.innerText = f.name;
                div.onclick = () => { currentIndex = idx; showCurrentImage(); };
                list.appendChild(div);
            });
        }

        function showCurrentImage() {
            const file = fileList[currentIndex];
            const blob = previewCache[file.name];
            
            document.getElementById('review-idx').innerText = currentIndex + 1;
            document.getElementById('review-progress').style.width = `${((currentIndex+1)/fileList.length)*100}%`;
            document.getElementById('filename-display').innerText = file.name;
            
            const img = document.getElementById('review-image');
            if (blob) {
                img.src = URL.createObjectURL(blob);
            } else {
                img.src = ''; // Placeholder for error/not found
            }
            renderThumbnailList();
        }

        function approveCurrent() {
            if (currentIndex < fileList.length - 1) {
                currentIndex++;
                showCurrentImage();
            } else {
                finishReview();
            }
        }

        function enterEditMode() {
            const file = fileList[currentIndex];
            const meta = metaCache[file.name];
            const img = document.getElementById('edit-image');
            
            document.getElementById('edit-wrapper').classList.remove('hidden');
            img.src = URL.createObjectURL(file);
            
            if (cropper) cropper.destroy();
            img.onload = () => {
                // Use initial bounding box from Python meta as starting point
                const initData = meta.found ? { x: meta.init_x, y: meta.init_y, width: meta.init_w, height: meta.init_h } : null;
                cropper = new Cropper(img, {
                    viewMode: 1,
                    data: initData
                });
            };
        }

        function saveEdit() {
            const data = cropper.getData();
            // Mark as modified so Python knows to use simple crop instead of strict deskew
            metaCache[fileList[currentIndex].name] = {
                modified: true,
                x: data.x, y: data.y, w: data.width, h: data.height
            };
            
            // Update preview locally
            cropper.getCroppedCanvas().toBlob(blob => {
                previewCache[fileList[currentIndex].name] = blob;
                cancelEdit();
                showCurrentImage();
            });
        }

        function cancelEdit() {
            document.getElementById('edit-wrapper').classList.add('hidden');
            if (cropper) cropper.destroy();
        }

        function finishReview() {
            document.getElementById('step-review').classList.add('hidden');
            document.getElementById('step-final').classList.remove('hidden');
            processFinalBatch();
        }

        async function processFinalBatch() {
            window.dispatchEvent(new CustomEvent('py-init-zip'));
            for (const file of fileList) {
                const buffer = await file.arrayBuffer();
                const meta = metaCache[file.name];
                
                await new Promise(resolve => {
                    window.finalizeDone = resolve;
                    window.dispatchEvent(new CustomEvent('py-process-item', {
                        detail: { buffer: new Uint8Array(buffer), filename: file.name, meta: meta }
                    }));
                });
            }
            window.dispatchEvent(new CustomEvent('py-close-zip'));
        }
        
        window.setDownloadUrl = (uint8array, filename) => {
            const blob = new Blob([uint8array], { type: 'application/zip' });
            const url = URL.createObjectURL(blob);
            const btn = document.getElementById('dl-btn');
            btn.classList.remove('hidden');
            btn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
            };
            btn.click();
        };
    </script>
</body>
</html>