<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banknote Autocrop - Human Review</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Cropper.js (For Human Review) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Dark Theme Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        navy: {
                            950: '#0B0F19', 
                            900: '#0f172a',
                            800: '#151B2D', 
                            700: '#1e293b', 
                        },
                        brand: {
                            blue: '#3b82f6',
                            green: '#10b981',
                            accent: '#6366f1',
                            danger: '#ef4444',
                        }
                    }
                }
            }
        }
    </script>
    
    <script type="py-config">
        { "packages": [] }
    </script>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.6.1/core.js"></script>

    <style>
        .cropper-view-box,
        .cropper-face {
            border-radius: 0; /* Banknotes are rectangles */
        }
        /* Custom Loading */
        .loading-overlay {
            backdrop-filter: blur(8px);
            background-color: rgba(11, 15, 25, 0.9);
        }
    </style>
</head>
<body class="bg-navy-950 text-slate-200 min-h-screen flex flex-col font-sans antialiased">

    <!-- Loading Overlay -->
    <div id="env-loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center transition-opacity duration-500 loading-overlay">
        <div class="relative w-16 h-16 mb-6">
            <div class="absolute inset-0 rounded-full border-4 border-slate-700"></div>
            <div class="absolute inset-0 rounded-full border-t-4 border-brand-blue animate-spin"></div>
        </div>
        <h2 class="text-xl font-bold tracking-tight text-white">Initializing AI Core</h2>
        <p id="loader-status" class="text-slate-400 mt-2 font-medium text-sm">Loading OpenCV Engine...</p>
    </div>

    <!-- Nav -->
    <nav class="border-b border-navy-700 bg-navy-950/80 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-blue to-brand-accent flex items-center justify-center text-white">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <span class="font-bold text-lg tracking-tight">Review Mode</span>
                </div>
                <div class="flex items-center gap-4">
                    <div id="queue-counter" class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-navy-800 rounded-full border border-navy-700">
                        <span class="text-xs font-semibold text-slate-300 tracking-wide">PENDING: <span id="pending-count" class="text-white font-bold">0</span></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-5xl mx-auto px-4 py-8 w-full flex flex-col h-full">

        <!-- Upload State -->
        <div id="upload-state" class="border-2 border-dashed border-navy-700 rounded-2xl p-12 text-center hover:border-brand-blue/50 hover:bg-navy-800/50 transition-all cursor-pointer group mb-8">
            <div class="w-16 h-16 bg-navy-800 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform shadow-lg shadow-black/20">
                <i class="fa-solid fa-images text-2xl text-brand-blue"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Upload for Human Review</h3>
            <p class="text-slate-400 mb-6 max-w-md mx-auto">Verify and adjust AI crops before processing.</p>
            <div class="flex justify-center gap-3">
                 <button onclick="document.getElementById('dropzone-file').click()" class="px-6 py-2 bg-navy-700 hover:bg-navy-600 text-white rounded-lg font-medium">Select Files</button>
                <input id="dropzone-file" type="file" class="hidden" multiple accept="image/*" />
            </div>
        </div>

        <!-- Editor Container (Hidden initially) -->
        <div id="editor-container" class="hidden flex-grow flex flex-col">
            
            <!-- Toolbar -->
            <div class="flex justify-between items-center mb-4">
                <h2 id="current-filename" class="text-lg font-medium text-white truncate max-w-md">filename.jpg</h2>
                <div class="flex gap-2">
                    <button onclick="rotateImage(-90)" class="w-10 h-10 rounded bg-navy-800 hover:bg-navy-700 text-slate-300" title="Rotate Left">
                        <i class="fa-solid fa-rotate-left"></i>
                    </button>
                    <button onclick="rotateImage(90)" class="w-10 h-10 rounded bg-navy-800 hover:bg-navy-700 text-slate-300" title="Rotate Right">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                    <button onclick="resetCrop()" class="w-10 h-10 rounded bg-navy-800 hover:bg-navy-700 text-brand-blue" title="Reset AI Crop">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </button>
                </div>
            </div>

            <!-- Image Area -->
            <div class="relative bg-navy-900 rounded-xl border border-navy-700 overflow-hidden flex-grow shadow-2xl" style="min-height: 500px; max-height: 70vh;">
                <img id="editor-image" src="" class="max-w-full h-auto opacity-0" />
                
                <!-- AI Thinking Overlay -->
                <div id="ai-analyzing" class="absolute inset-0 z-20 bg-navy-950/80 flex flex-col items-center justify-center hidden">
                    <div class="w-12 h-12 border-4 border-brand-blue border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-brand-blue font-bold animate-pulse">AI Analyzing...</p>
                </div>
            </div>

            <!-- Footer Controls -->
            <div class="mt-6 flex justify-between items-center">
                <div class="text-sm text-slate-500">
                    Step <span id="current-step" class="text-white font-bold">1</span> of <span id="total-step">?</span>
                </div>
                
                <div class="flex gap-4">
                    <button onclick="skipImage()" class="px-6 py-3 rounded-lg border border-navy-700 text-slate-400 hover:text-white hover:bg-navy-800 transition-colors font-medium">
                        Skip
                    </button>
                    <button id="approve-btn" onclick="approveAndNext()" class="px-8 py-3 rounded-lg bg-brand-green hover:bg-green-600 text-white shadow-lg shadow-green-500/20 font-bold flex items-center gap-2 transition-transform active:scale-95">
                        <i class="fa-solid fa-check"></i> Approve & Next
                    </button>
                </div>
            </div>
        </div>

        <!-- Finish Screen -->
        <div id="finish-screen" class="hidden text-center py-12">
            <div class="w-24 h-24 mx-auto rounded-full bg-brand-green/20 flex items-center justify-center text-brand-green mb-6 text-4xl">
                <i class="fa-solid fa-flag-checkered"></i>
            </div>
            <h2 class="text-3xl font-bold text-white mb-4">Session Complete!</h2>
            <p class="text-slate-400 mb-8">You have reviewed <span id="final-count" class="text-white font-bold">0</span> images.</p>
            <button id="download-final-btn" class="px-8 py-4 bg-brand-blue hover:bg-blue-600 text-white rounded-full font-bold shadow-xl shadow-blue-500/20 text-lg">
                <i class="fa-solid fa-download mr-2"></i> Download ZIP
            </button>
            <p class="mt-6">
                <a href="#" onclick="location.reload()" class="text-slate-500 hover:text-white text-sm">Start New Session</a>
            </p>
        </div>

    </main>

    <!-- JS Logic -->
    <script>
        let cropper = null;
        let fileQueue = [];
        let currentFileIndex = -1;
        let processedResults = []; // Store {filename, blob} for ZIP
        let zipBlob = null;

        const fileInput = document.getElementById('dropzone-file');
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileQueue = Array.from(e.target.files);
                startReviewSession();
            }
        });

        function startReviewSession() {
            document.getElementById('upload-state').classList.add('hidden');
            document.getElementById('editor-container').classList.remove('hidden');
            document.getElementById('queue-counter').classList.remove('hidden');
            document.getElementById('total-step').innerText = fileQueue.length;
            
            // Start Python ZIP engine
            window.dispatchEvent(new CustomEvent('init-zip'));

            loadNextImage();
        }

        async function loadNextImage() {
            currentFileIndex++;
            
            if (currentFileIndex >= fileQueue.length) {
                finishSession();
                return;
            }

            // Update UI
            document.getElementById('pending-count').innerText = fileQueue.length - currentFileIndex;
            document.getElementById('current-step').innerText = currentFileIndex + 1;
            document.getElementById('current-filename').innerText = fileQueue[currentFileIndex].name;
            document.getElementById('ai-analyzing').classList.remove('hidden'); // Show loading
            
            const file = fileQueue[currentFileIndex];
            const url = URL.createObjectURL(file);
            const img = document.getElementById('editor-image');
            
            // Reset Cropper if exists
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            img.src = url;
            img.onload = () => {
                // Initialize Cropper (Disabled initially until AI analyzes)
                cropper = new Cropper(img, {
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.5,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
                
                // Ask Python to analyze
                file.arrayBuffer().then(buffer => {
                    // Send to Python
                    const event = new CustomEvent('analyze-image', { 
                        detail: { 
                            buffer: new Uint8Array(buffer),
                            filename: file.name
                        } 
                    });
                    window.dispatchEvent(event);
                });
            };
        }

        // Callback from Python with AI suggested crop
        window.applyAIBox = function(x, y, w, h, angle) {
            document.getElementById('ai-analyzing').classList.add('hidden');
            
            if (cropper) {
                // If angle is significant, rotate image first
                // Note: Cropper.js rotation might change coordinate space, simpler to just set box for now
                if (Math.abs(angle) > 1) {
                    cropper.rotate(angle);
                }
                
                // Set Crop Box (Need to convert if rotated? Let's assume Py returns raw rect relative to original)
                // Cropper.js setData expects natural image coordinates
                cropper.setData({
                    x: x,
                    y: y,
                    width: w,
                    height: h
                });
            }
        };

        async function approveAndNext() {
            if (!cropper) return;
            
            // Get final data
            // We get the cropped canvas directly from Cropper.js for simplicity
            // But to support "Shadow Upload" of ORIGINAL + COORDS, we need the data.
            const data = cropper.getData(); // {x, y, width, height, rotate}
            
            // 1. Get Cropped Blob for User ZIP
            cropper.getCroppedCanvas({
                imageSmoothingQuality: 'high'
            }).toBlob(async (blob) => {
                // Send to Python to add to ZIP and Shadow Upload
                // We need to pass the ORIGINAL buffer again or keep it in Py? 
                // Better: Pass the crop blob to Py to save, and Py has the original in memory? 
                // No, Py memory is volatile per call. 
                // Let's send the *Crop Info* back to Py, and let Py do the heavy lifting (re-read original).
                
                const file = fileQueue[currentFileIndex];
                const buffer = await file.arrayBuffer();
                
                const event = new CustomEvent('finalize-image', {
                    detail: {
                        buffer: new Uint8Array(buffer),
                        filename: file.name,
                        cropData: data // {x, y, width, height, rotate} from CropperJS
                    }
                });
                window.dispatchEvent(event);

                loadNextImage();
            }, 'image/png');
        }

        function skipImage() {
            loadNextImage();
        }
        
        function rotateImage(deg) {
            if(cropper) cropper.rotate(deg);
        }
        
        function resetCrop() {
            if(cropper) cropper.reset();
        }

        function finishSession() {
            document.getElementById('editor-container').classList.add('hidden');
            document.getElementById('finish-screen').classList.remove('hidden');
            document.getElementById('final-count').innerText = currentFileIndex;
            
            // Trigger Python to close ZIP
            window.dispatchEvent(new CustomEvent('close-zip'));
        }
        
        // Python calls this when ZIP is ready
        window.setDownloadUrl = function(uint8array, filename) {
            const blob = new Blob([uint8array], { type: 'application/zip' });
            const url = URL.createObjectURL(blob);
            const btn = document.getElementById('download-final-btn');
            btn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
            };
        }
    </script>
    
    <!-- Python Script -->
    <script type="py" src="/script.py?v=14"></script>
</body>
</html>