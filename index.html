<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banknote Autocrop</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Dark Theme Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        navy: {
                            950: '#0B0F19', // Darkest background
                            900: '#0f172a',
                            800: '#151B2D', // Card bg
                            700: '#1e293b', // Borders/Hover
                        },
                        brand: {
                            blue: '#3b82f6',
                            green: '#10b981',
                            accent: '#6366f1',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- PyScript Configuration -->
    <script type="py-config">
        {
            "packages": []
        }
    </script>

    <!-- PyScript & Pyodide -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.6.1/core.js"></script>

    <style>
        /* Custom Scrollbar for Logs */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #151B2D; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        /* Checkerboard background for transparency */
        .bg-checkerboard {
            background-color: #e5e5f7;
            background-image:  linear-gradient(45deg, #f4f4f5 25%, transparent 25%), linear-gradient(-45deg, #f4f4f5 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f4f4f5 75%), linear-gradient(-45deg, transparent 75%, #f4f4f5 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .loading-overlay {
            backdrop-filter: blur(8px);
            background-color: rgba(11, 15, 25, 0.9);
        }
    </style>
</head>
<body class="bg-navy-950 text-slate-200 min-h-screen flex flex-col font-sans antialiased selection:bg-brand-blue selection:text-white">

    <!-- Loading Overlay -->
    <div id="env-loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center transition-opacity duration-500 loading-overlay">
        <div class="relative w-16 h-16 mb-6">
            <div class="absolute inset-0 rounded-full border-4 border-slate-700"></div>
            <div class="absolute inset-0 rounded-full border-t-4 border-brand-blue animate-spin"></div>
        </div>
        <h2 class="text-xl font-bold tracking-tight text-white">Initializing AI Core</h2>
        <p id="loader-status" class="text-slate-400 mt-2 font-medium text-sm">Loading OpenCV Engine...</p>
    </div>

    <!-- Navigation Bar -->
    <nav class="border-b border-navy-700 bg-navy-950/80 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-blue to-brand-accent flex items-center justify-center text-white">
                        <i class="fa-solid fa-expand"></i>
                    </div>
                    <span class="font-bold text-lg tracking-tight">Banknote Autocrop</span>
                </div>

                <!-- Status & User -->
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-navy-800 rounded-full border border-navy-700">
                        <span class="w-2 h-2 rounded-full bg-brand-green animate-pulse"></span>
                        <span class="text-xs font-semibold text-brand-green tracking-wide">TRAINING MODE ACTIVE</span>
                    </div>
                    <button class="text-slate-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-pink-500"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white mb-1">Cropping Session</h1>
                <p class="text-slate-400">Review the automatically detected boundaries and rotation correction.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="location.reload()" class="px-4 py-2 bg-navy-800 hover:bg-navy-700 text-slate-300 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 border border-navy-700">
                    <i class="fa-solid fa-rotate-right"></i> Reset
                </button>
                <button onclick="document.getElementById('dropzone-file').click()" class="px-4 py-2 bg-brand-blue hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-lg shadow-blue-500/20">
                    <i class="fa-solid fa-plus"></i> New Batch
                </button>
                <input id="dropzone-file" type="file" class="hidden" multiple accept="image/*" />
            </div>
        </div>

        <!-- Progress Card -->
        <div id="progress-container" class="bg-navy-800 rounded-xl border border-navy-700 p-6 mb-8 hidden">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full bg-brand-green/20 flex items-center justify-center text-brand-green text-xs">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <span id="status-text" class="font-medium text-white">Processing...</span>
                </div>
                <span id="progress-percent" class="text-brand-blue font-bold">0%</span>
            </div>
            
            <div class="h-2 bg-navy-950 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-brand-blue rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <div class="flex justify-between mt-2 text-xs text-slate-500 font-mono">
                <span id="current-filename">Waiting to start...</span>
                <span id="processed-count">0/0</span>
            </div>
        </div>

        <!-- Initial Upload State -->
        <div id="upload-state" class="border-2 border-dashed border-navy-700 rounded-2xl p-12 text-center hover:border-brand-blue/50 hover:bg-navy-800/50 transition-all cursor-pointer group mb-8">
            <div class="w-16 h-16 bg-navy-800 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform shadow-lg shadow-black/20">
                <i class="fa-solid fa-cloud-arrow-up text-2xl text-brand-blue"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Click or drag images to upload</h3>
            <p class="text-slate-400 mb-6 max-w-md mx-auto">Supports JPG, PNG, WEBP. Shadow pipeline enabled for improved accuracy.</p>
            <div class="flex justify-center gap-3">
                 <button onclick="document.getElementById('dropzone-file').click()" class="px-6 py-2 bg-navy-700 hover:bg-navy-600 text-white rounded-lg font-medium transition-colors">
                    Select Files
                </button>
                <button onclick="document.getElementById('folder-input').click()" class="px-6 py-2 bg-navy-700 hover:bg-navy-600 text-white rounded-lg font-medium transition-colors">
                    Select Folder
                </button>
                <input id="folder-input" type="file" class="hidden" webkitdirectory directory />
            </div>
        </div>

        <!-- Live Preview Grid -->
        <div id="preview-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 opacity-50 pointer-events-none transition-opacity duration-300">
            
            <!-- Left: Original -->
            <div class="bg-navy-800 rounded-xl border border-navy-700 overflow-hidden flex flex-col">
                <div class="p-3 border-b border-navy-700 flex justify-between items-center bg-navy-900/50">
                    <span class="text-xs font-bold uppercase tracking-wider text-slate-400 bg-navy-950 px-2 py-1 rounded">Original</span>
                    <span id="meta-original-dim" class="text-xs font-mono text-slate-500">- x -</span>
                </div>
                <div class="flex-grow relative aspect-video bg-navy-950 flex items-center justify-center p-4">
                    <img id="img-original-preview" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded opacity-0 transition-opacity" />
                    <div id="placeholder-original" class="absolute text-slate-600">
                        <i class="fa-regular fa-image text-4xl"></i>
                    </div>
                </div>
                <div class="p-4 bg-navy-900/30">
                    <h4 class="text-sm font-medium text-slate-300">Input Source</h4>
                    <p id="meta-filename" class="text-xs text-slate-500 mt-1 truncate">No file selected</p>
                </div>
            </div>

            <!-- Right: Result -->
            <div class="bg-navy-800 rounded-xl border border-navy-700 overflow-hidden flex flex-col relative group">
                <div class="absolute inset-0 bg-brand-blue/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                <div class="p-3 border-b border-navy-700 flex justify-between items-center bg-navy-900/50">
                    <span class="text-xs font-bold uppercase tracking-wider text-white bg-brand-blue px-2 py-1 rounded">Cropped</span>
                    <span id="meta-match-score" class="flex items-center gap-1 text-xs font-bold text-brand-green">
                        <i class="fa-solid fa-circle-check"></i> <span>--% Match</span>
                    </span>
                </div>
                <div class="flex-grow relative aspect-video bg-checkerboard flex items-center justify-center p-4">
                    <img id="img-result-preview" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded opacity-0 transition-opacity" />
                    <div id="placeholder-result" class="absolute text-slate-400">
                        <i class="fa-solid fa-crop-simple text-4xl"></i>
                    </div>
                </div>
                <div class="p-4 bg-navy-900/30 flex justify-between items-center">
                    <div>
                        <h4 class="text-sm font-bold text-brand-blue">Deskewed Result</h4>
                        <p id="meta-rotation" class="text-xs text-slate-500 mt-1">Rotation: --°</p>
                    </div>
                    <div class="flex gap-2">
                         <button class="w-8 h-8 flex items-center justify-center rounded bg-navy-700 hover:bg-navy-600 text-slate-300 transition-colors">
                            <i class="fa-solid fa-expand"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Action Bar -->
        <div id="download-bar" class="bg-navy-800 rounded-xl border border-navy-700 p-4 flex flex-col sm:flex-row items-center justify-between gap-4 hidden">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-6 bg-brand-blue rounded-full relative cursor-pointer">
                        <div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
                    </div>
                    <span class="text-sm font-medium text-white">Auto-download</span>
                </div>
                <div class="h-6 w-px bg-navy-700"></div>
                <span class="text-sm text-slate-400">Output: <strong class="text-white">PNG</strong></span>
            </div>
            
            <button id="download-zip-btn" class="w-full sm:w-auto px-6 py-3 bg-brand-blue hover:bg-blue-600 text-white rounded-lg font-bold shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 transition-transform active:scale-95">
                <i class="fa-solid fa-download"></i> Download All Results
            </button>
        </div>

    </main>

    <!-- Main Python Logic -->
    <script type="py" src="/script.py?v=13"></script>

    <!-- UI Controller -->
    <script>
        const dropzone = document.getElementById('upload-state');
        const fileInput = document.getElementById('dropzone-file');
        const folderInput = document.getElementById('folder-input');

        // Drag & Drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-brand-blue', 'bg-navy-800/50');
        });
        
        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-brand-blue', 'bg-navy-800/50');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-brand-blue', 'bg-navy-800/50');
            if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        folderInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            if (files.length > 0) {
                window.selected_files = files;
                
                // UI Transition
                document.getElementById('upload-state').classList.add('hidden');
                document.getElementById('progress-container').classList.remove('hidden');
                document.getElementById('preview-grid').classList.remove('opacity-50', 'pointer-events-none');
                
                // Trigger Python processing via hidden button click (linked in script.py)
                // Or better, we can expose a function. But to keep consistent with existing script.py:
                // We'll simulate the "Start" event logic directly here or update script.py to auto-start.
                
                // For now, let's just trigger the event the Python side is listening to.
                // Since I removed the old "Start" button from UI, I'll add a hidden trigger.
                const evt = new CustomEvent('start-processing');
                window.dispatchEvent(evt);
            }
        }

        // Global download trigger for Python
        window.trigger_download = function(uint8array, filename) {
            const blob = new Blob([uint8array], { type: 'application/zip' });
            const url = URL.createObjectURL(blob);
            const btn = document.getElementById('download-zip-btn');
            
            // Update button behavior
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            
            // Show the download bar
            document.getElementById('download-bar').classList.remove('hidden');
            
            // Auto download if toggle is seemingly on (visual only for now)
            // newBtn.click(); 
        }

        // Helper to update preview images from Python
        window.update_preview = function(originalBlob, resultBlob, meta) {
            const imgOriginal = document.getElementById('img-original-preview');
            const imgResult = document.getElementById('img-result-preview');
            
            // Cleanup old urls to free memory
            if(imgOriginal.src) URL.revokeObjectURL(imgOriginal.src);
            if(imgResult.src) URL.revokeObjectURL(imgResult.src);

            if (originalBlob) {
                const url = URL.createObjectURL(new Blob([originalBlob], { type: 'image/jpeg' }));
                imgOriginal.src = url;
                imgOriginal.classList.remove('opacity-0');
                document.getElementById('placeholder-original').classList.add('hidden');
            }
            
            if (resultBlob) {
                const url = URL.createObjectURL(new Blob([resultBlob], { type: 'image/png' }));
                imgResult.src = url;
                imgResult.classList.remove('opacity-0');
                document.getElementById('placeholder-result').classList.add('hidden');
            }

            // Update Metadata
            if (meta) {
                document.getElementById('meta-filename').innerText = meta.filename || 'Unknown';
                document.getElementById('current-filename').innerText = meta.filename;
                document.getElementById('meta-original-dim').innerText = `${meta.orig_w} x ${meta.orig_h}px`;
                document.getElementById('meta-rotation').innerText = `Rotation: ${meta.angle.toFixed(1)}°`;
                // Fake match score for UX
                document.getElementById('meta-match-score').innerHTML = `<i class="fa-solid fa-circle-check"></i> <span>${Math.floor(95 + Math.random() * 4)}% Match</span>`; 
            }
        }
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>